---
import Layout from "../layouts/Layout.astro";
import { Image } from "astro:assets";

const imageModules = import.meta.glob("../assets/affiches-optimized/*.{jpg,jpeg,png,webp,avif,JPG,JPEG,PNG,WEBP,AVIF}", {
  eager: true,
});


const pdfModules = import.meta.glob("../assets/affiches-optimized/*.pdf", { eager: true });

const images = Object.entries(imageModules).map(([path, mod], idx) => {
  const fileName = path.split("/").pop() ?? "";
  const yearMatch = fileName.match(/(19|20)\d{2}/);
  const year = yearMatch ? Number(yearMatch[0]) : null;
  return {
    type: "image",
    year,
    idx,
    fileName,
    src: (mod as any).default, // ImageMetadata
  };
});

const pdfs = Object.entries(pdfModules).map(([path, mod], idx) => {
  const fileName = path.split("/").pop() ?? "";
  const yearMatch = fileName.match(/(19|20)\d{2}/);
  const year = yearMatch ? Number(yearMatch[0]) : null;
  return {
    type: "pdf",
    year,
    idx: 10_000 + idx, // keep stable ordering after images
    fileName,
    src: (mod as any).default as string, // built URL
  };
});

const affiches = [...images, ...pdfs].sort((a, b) => {
  const ay = a.year ?? -1;
  const by = b.year ?? -1;
  if (by !== ay) return by - ay;
  return a.idx - b.idx;
});
---

<Layout title="Affiches | Herderrock" showHero={false}>
  <main class="affiches-main">
    {affiches.map((a, i) => {
      const left = i % 2 === 0;
      const contentBgClass = left ? "content-white" : "content-red";

      return (
        <section class="affiche-section padding-top">
          <div class="full">
            {left ? (
              <>
                <h2 class="title title-left">
                  Affiche <strong>{a.year ?? ""}</strong>
                </h2>
                <div class="empty-50" aria-hidden="true"></div>
              </>
            ) : (
              <>
                <div class="empty-50" aria-hidden="true"></div>
                <h2 class="title title-right">
                  Affiche <strong>{a.year ?? ""}</strong>
                </h2>
              </>
            )}
          </div>

          <article class={`affiche-content ${contentBgClass} padding-x padding-y`}>
            {a.type === "pdf" ? (
              <iframe
                src={a.src}
                title={`Herderrock affiche ${a.year ?? ""}`}
                loading="lazy"
              />
            ) : (
              <Image
                src={a.src}
                alt={`Herderrock affiche ${a.year ?? ""}`}
                widths={[600, 900, 1200, 1600, 2000]}
                sizes="(max-width: 768px) 95vw, 90vw"
                format="webp"
                loading={i === 0 ? "eager" : "lazy"}
                fetchpriority={i === 0 ? "high" : "auto"}
              />
            )}
          </article>
        </section>
      );
    })}
  </main>
</Layout>

<style>
  .affiches-main {
    width: 100%;
    background: var(--white);
  }

  .affiche-section {
    background: var(--white);
  }

  .full {
    width: 100%;
    display: flex;
  }

  .empty-50 {
    width: 50%;
    height: 1px;
    display: block;
  }

  /* keep same behavior as global, but scoped */
  .affiche-section .title {
    width: 50%;
    transition: width 0.2s ease-out;
  }

  .affiche-section:hover .title {
    width: 70%;
  }

  .affiche-content {
    display: flex;
    justify-content: center;
    align-items: center;
    padding-top: clamp(16px, 3vh, 32px);
  }

  .content-white {
    background: var(--white);
  }

  .content-red {
    background: var(--red);
  }

  /* Image component outputs an <img>, so this still applies */
  .affiche-content :global(img),
  .affiche-content iframe {
    width: auto;
    height: auto;
    max-width: 90vw;
    max-height: calc(100vh - 220px);
    object-fit: contain;

    background: var(--white);
    border: none;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.08);
  }

  @media (max-width: 768px) {
    .affiche-section .title,
    .affiche-section:hover .title {
      width: 90%;
      max-width: 90vw;
    }

    .empty-50 {
      width: 10%;
    }

    .affiche-content :global(img),
    .affiche-content iframe {
      max-width: 95vw;
      max-height: calc(100vh - 200px);
    }
  }
</style>
